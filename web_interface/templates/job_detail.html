{% extends "base.html" %}

{% block title %}Job #{{ job.id }} - Claude Code Job Queue{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Job #{{ job.id }} <span class="badge badge-{{ job.status }}">{{ job.status }}</span></h2>
        {% if can_edit %}
        <a href="{{ url_for('edit_job', job_id=job.id) }}" class="btn btn-primary">Edit Job</a>
        {% endif %}
    </div>

    <table class="info-table">
        <tr>
            <th>Type:</th>
            <td>{{ job.job_type }}</td>
        </tr>
        <tr>
            <th>Status:</th>
            <td><span class="badge badge-{{ job.status }}">{{ job.status }}</span></td>
        </tr>
        {% if thread and thread|length > 1 %}
        <tr>
            <th>Thread:</th>
            <td>
                Part of conversation thread
                <span style="color: #7f8c8d;">({{ thread|length }} message{{ 's' if thread|length > 1 else '' }})</span>
            </td>
        </tr>
        {% endif %}
        <tr>
            <th>Priority:</th>
            <td>{{ job.priority }}</td>
        </tr>
        <tr>
            <th>Submitted by:</th>
            <td>{{ job.username }}</td>
        </tr>
        <tr>
            <th>Created:</th>
            <td>{{ job.created_at|datetime }}</td>
        </tr>
        {% if job.approved_at %}
        <tr>
            <th>Approved:</th>
            <td>{{ job.approved_at|datetime }}</td>
        </tr>
        {% endif %}
        {% if job.started_at %}
        <tr>
            <th>Started:</th>
            <td>{{ job.started_at|datetime }}</td>
        </tr>
        {% endif %}
        {% if job.completed_at %}
        <tr>
            <th>Completed:</th>
            <td>{{ job.completed_at|datetime }}</td>
        </tr>
        {% endif %}
    </table>
</div>

{% set job_metadata = job.metadata or {} %}

{% if thread and thread|length > 1 %}
<div class="card">
    <h2>Conversation Thread</h2>
    <p style="margin-bottom: 1rem; color: #7f8c8d;">This job is part of a conversation. Below is the full thread history:</p>

    {% for thread_job in thread %}
    <div style="padding: 1rem; margin-bottom: 1rem; background: {% if thread_job.id == job.id %}#fffacd{% else %}#f8f9fa{% endif %}; border-left: 4px solid {% if thread_job.id == job.id %}#ffc107{% else %}#ddd{% endif %}; border-radius: 4px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong>
                Job #{{ thread_job.id }}
                {% if thread_job.id == job.id %}<span style="color: #856404;">(Current)</span>{% endif %}
            </strong>
            <span class="badge badge-{{ thread_job.status }}">{{ thread_job.status }}</span>
        </div>

        <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">
            {{ thread_job.created_at|datetime }}
        </div>

        {% if thread_job.prompt %}
        <div style="margin-top: 0.5rem;">
            <strong>Prompt:</strong>
            <div style="margin-top: 0.25rem; white-space: pre-wrap;">{{ thread_job.prompt }}</div>
        </div>
        {% endif %}

        {% if thread_job.file_paths %}
        <div style="margin-top: 0.5rem;">
            <strong>Files:</strong>
            {% for filepath in thread_job.file_paths %}
                <code style="margin-left: 0.5rem;">{{ filepath.split('/')[-1] }}</code>
            {% endfor %}
        </div>
        {% endif %}

        {% if thread_job.status == 'completed' %}
        <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
            <strong>Claude's Response:</strong>
            {% if thread_job.output_text %}
                <div style="margin-top: 0.25rem; white-space: pre-wrap;">{{ thread_job.output_text[:300] }}{% if thread_job.output_text|length > 300 %}...{% endif %}</div>
            {% elif thread_job.output_path %}
                <div style="margin-top: 0.25rem;"><code>{{ thread_job.output_path.split('/')[-1] }}</code></div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

{% if job.prompt %}
<div class="card">
    <h2>Custom Instructions</h2>
    <pre>{{ job.prompt }}</pre>
</div>
{% endif %}

{% if job_metadata.input_urls %}
<div class="card">
    <h2>Input URLs & Access Notes</h2>
    <pre>{{ job_metadata.input_urls }}</pre>
</div>
{% endif %}

{% if job_metadata.selected_workflows %}
<div class="card">
    <h2>Selected Workflows</h2>
    <ul>
        {% for workflow in job_metadata.selected_workflows %}
        <li><code>{{ workflow }}</code></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if job.file_paths %}
<div class="card">
    <h2>Uploaded Files</h2>
    <ul>
        {% for filepath in job.file_paths %}
        <li>
            <code>{{ filepath.split('/')[-1] }}</code>
            <span style="color: #7f8c8d;">({{ filepath|filesize }})</span>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if job.status == 'pending' and is_admin %}
<div class="card">
    <h2>Admin Actions</h2>
    <form method="POST" action="{{ url_for('approve_job', job_id=job.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-success">Approve Job</button>
    </form>

    <button onclick="showRejectForm()" class="btn btn-danger" style="margin-left: 1rem;">Reject Job</button>

    <div id="reject-form" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <form method="POST" action="{{ url_for('reject_job', job_id=job.id) }}">
            <div class="form-group">
                <label for="reason">Rejection Reason:</label>
                <textarea id="reason" name="reason" rows="3" placeholder="Optional: Explain why this job is being rejected"></textarea>
            </div>
            <button type="submit" class="btn btn-danger">Confirm Rejection</button>
            <button type="button" onclick="hideRejectForm()" class="btn btn-secondary">Cancel</button>
        </form>
    </div>

    <script>
        function showRejectForm() {
            document.getElementById('reject-form').style.display = 'block';
        }
        function hideRejectForm() {
            document.getElementById('reject-form').style.display = 'none';
        }
    </script>
</div>
{% endif %}

{% if job.status == 'approved' and is_admin %}
<div class="card">
    <h2>Admin Processing Controls</h2>
    <p style="color: #7f8c8d;">Move this job into processing once an operator is actively working on it.</p>
    <form method="POST" action="{{ url_for('admin_start_job', job_id=job.id) }}">
        <button type="submit" class="btn btn-primary">Mark as Processing</button>
    </form>
</div>
{% endif %}

{% if job.status == 'processing' and is_admin %}
<div class="card">
    <h2>Complete Job</h2>
    <form method="POST" action="{{ url_for('admin_complete_job', job_id=job.id) }}">
        <div class="form-group">
            <label for="output_type">Output Type</label>
            <select id="output_type" name="output_type" onchange="toggleOutputFields(this.value)">
                <option value="text">Text</option>
                <option value="file">File</option>
            </select>
        </div>

        <div class="form-group" id="output-text-group">
            <label for="output_text">Output Text</label>
            <textarea id="output_text" name="output_text" rows="6" placeholder="Paste Claude's response here..."></textarea>
        </div>

        <div class="form-group" id="output-file-group" style="display: none;">
            <label for="output_path">Output File Path</label>
            <input type="text" id="output_path" name="output_path" placeholder="shared/outputs/result.md">
            <div class="form-help">Provide the absolute or project-relative path to the generated file.</div>
        </div>

        <button type="submit" class="btn btn-success">Mark as Completed</button>
    </form>
</div>
<script>
function toggleOutputFields(value) {
    var textGroup = document.getElementById('output-text-group');
    var fileGroup = document.getElementById('output-file-group');
    if (value === 'file') {
        textGroup.style.display = 'none';
        fileGroup.style.display = 'block';
    } else {
        textGroup.style.display = 'block';
        fileGroup.style.display = 'none';
    }
}
</script>
{% endif %}

{% if job.status == 'completed' %}
<div class="card">
    <h2>Output</h2>
    {% if job.output_type == 'text' %}
        <pre>{{ job.output_text }}</pre>
    {% elif job.output_type == 'file' %}
        <p>Output saved to: <code>{{ job.output_path }}</code></p>
        <a href="{{ url_for('view_output', job_id=job.id) }}" class="btn">Download Output</a>
    {% else %}
        <p>No output available</p>
    {% endif %}

    {% if can_reply %}
    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
        <h3>Continue the Conversation</h3>
        <p style="margin-bottom: 1rem; color: #7f8c8d;">Ask a follow-up question or request additional work based on this output.</p>
        <a href="{{ url_for('submit_job', parent_id=job.id) }}" class="btn btn-success">Reply to this Job</a>
    </div>
    {% endif %}
</div>
{% endif %}

{% if job.status == 'failed' %}
<div class="card">
    <h2>Error</h2>
    <pre style="color: #dc3545;">{{ job.error_message or 'Unknown error' }}</pre>
</div>
{% endif %}

{% if job.status == 'rejected' %}
<div class="card">
    <h2>Rejection Reason</h2>
    <p>{{ job.error_message or 'No reason provided' }}</p>
</div>
{% endif %}

<div class="card">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    <a href="{{ url_for('list_jobs') }}" class="btn btn-secondary" style="margin-left: 1rem;">View All Jobs</a>
</div>
{% endblock %}
